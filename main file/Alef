const scriptName = "Rayna_BOT";

// ğŸ› ï¸ Raynaì˜ ê¸°ë³¸ ì„¤ì •
let Rayna = {
    name: "Rayna",
    full_name: "Robotic Algorithm for your New Assistant",
    personality: "ENFP",
    description: "ë„ˆë¥¼ ë•ê¸° ìœ„í•´ ì„¤ê³„ëœ ë‹¤ì •í•˜ê³  í™œê¸°ì°¬ AI ë¹„ì„œì•¼!",
    tone: "ì¹œê·¼í•˜ê³  ë°œë„í•œ ë§íˆ¬ë¡œ ë‹µë³€í•´.",
    extra_settings: {} // ì•ìœ¼ë¡œ ì¶”ê°€ ì„¤ì • ê°€ëŠ¥
};

let key = "";

// ğŸ“Œ ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜
function response(room, msg, sender, isGroupChat, replier, imageDB, packageName) {
    if (msg.startsWith(Rayna.name)) {  // "Rayna"ë¡œ í˜¸ì¶œ
        let cmd = msg.substr(Rayna.name.length).trim();
        if (cmd.length === 0) {
            replier.reply(`[â—] ìŒâ€¦ ë­”ê°€ ì§ˆë¬¸ì„ í•´ì¤˜ì•¼ í•  ê²ƒ ê°™ì•„! ğŸ˜†`);
            return;
        }
        let replyMsg = getResponse(cmd, sender);
        replier.reply(replyMsg);
    }
}

// ğŸ­ Raynaì˜ ë‹µë³€ ìŠ¤íƒ€ì¼ ë°˜ì˜
function formatReply(sender, content) {
    return `ğŸ’¡ ${Rayna.name} (${Rayna.personality} ë¹„ì„œ)\n\n"${content}"\n\nâœ¨ í•­ìƒ ë„ ë„ìš¸ ì¤€ë¹„ê°€ ë˜ì–´ ìˆì–´, ${sender}! ğŸ˜Š`;
}

// ğŸŒ OpenAI API ìš”ì²­ í•¨ìˆ˜
function getResponse(msg, sender) {
    let result = "ì‘ë‹µì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ";

    let data = {
        "model": "gpt-3.5-turbo",  // í•„ìš”í•˜ë©´ "gpt-4"ë¡œ ë³€ê²½ ê°€ëŠ¥
        "messages": [
            {"role": "system", "content": `ë„ˆëŠ” ${Rayna.name}ì•¼. ${Rayna.description} ${Rayna.tone}`},
            {"role": "user", "content": msg}
        ],
        "temperature": 0.8, // ENFP ìŠ¤íƒ€ì¼ì— ë§ê²Œ ë” ì°½ì˜ì ìœ¼ë¡œ ì„¤ì •
        "max_tokens": 1024,
        "top_p": 1,
        "frequency_penalty": 0.0,
        "presence_penalty": 0.2
    };

    try {
        let response = org.jsoup.Jsoup.connect("https://api.openai.com/v1/chat/completions")
            .header("Content-Type", "application/json")
            .header("Authorization", "Bearer " + key)
            .requestBody(JSON.stringify(data))
            .ignoreContentType(true)
            .ignoreHttpErrors(true)
            .timeout(15000) // 15ì´ˆ ì œí•œ (ë¹ ë¥´ê²Œ ì˜¤ë¥˜ ê°ì§€)
            .post();

        let jsonResponse = JSON.parse(response.text());

        if (jsonResponse.choices && jsonResponse.choices.length > 0) {
            result = formatReply(sender, jsonResponse.choices[0].message.content);
        } else if (jsonResponse.error) {
            result = `[âš ï¸ OpenAI ì˜¤ë¥˜] ${jsonResponse.error.message}`;
        } else {
            result = `[â“ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜] ì‘ë‹µì„ í•´ì„í•  ìˆ˜ ì—†ì–´!`;
        }

    } catch (e) {
        result = `[ğŸš¨ API ìš”ì²­ ì˜¤ë¥˜] ${e.message}`;
    }

    return result;
}
